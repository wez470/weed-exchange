<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">

<dom-module id="my-reviews">
  <template>
    <style>
      .content {
        margin: 0px 20px;
      }
      .input {
        display: flex;
        align-items: center;
        flex-direction: column;
      }
      .table {
        margin-top: 20px;
        height: 100%;
      }
      .spinner {
        display: flex;
        justify-content: center
      }
      .link {
        text-decoration: none;
      }
      paper-button.green {
        color: var(--app-secondary-color);
        background-color: var(--app-primary-color);
      }
      paper-spinner-lite[active] {
        margin: 30px 0px;
        display: block;
      }
      paper-spinner-lite {
        display: none;
      }
      paper-spinner-lite.green {
        --paper-spinner-color: var(--app-primary-color);
      }
      [hidden] { display: none !important; }
    </style>
    <div class="content">
      <div class="input">
        <h1>Search Cannabis Strain</h1>
        <paper-input value="{{searchString}}"></paper-input>
        <paper-button class="green" on-click="searchStrain">search</paper-button>
      </div>
      
      <div hidden$="[[noData]]" class="spinner">
        <paper-spinner-lite alt="Loading Strain Data" active$="[[loading]]" class="green"></paper-spinner-lite>
      </div>      
      <vaadin-grid hidden$="[[loading]]" class="table" items="[[strainData]]" multi-sort>
        
        <vaadin-grid-column>
          <template class="header">
              <vaadin-grid-sorter path="strain">Strain</vaadin-grid-sorter>
          </template>
          <template>[[item.strain]]</template>
        </vaadin-grid-column>
    
        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="allbud.rating">Allbud Rating</vaadin-grid-sorter>
          </template>
          <template><a class="link" href$="[[item.allbud.url]]">[[item.allbud.rating]]</a></template>
        </vaadin-grid-column> -->

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="allbud.ratings">Total Allbud Ratings</vaadin-grid-sorter>
          </template>
          <template>[[item.allbud.ratings]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="leafly.rating">Leafly Rating</vaadin-grid-sorter>
          </template>
          <template><a class="link" href$="[[item.leafly.url]]">[[item.leafly.rating]]</a></template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="leafly.ratings">Total Leafly Ratings</vaadin-grid-sorter>
          </template>
          <template>[[item.leafly.ratings]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="metachronic.rating">Combined Rating</vaadin-grid-sorter>
          </template>
          <template>[[item.metachronic.rating]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="metachronic.ratings">Total Combined Ratings</vaadin-grid-sorter>
          </template>
          <template>[[item.metachronic.ratings]]</template>
        </vaadin-grid-column>
    
      </vaadin-grid>
    </div>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
      class MyReviews extends Polymer.Element {
      static get is() { return 'my-reviews'; }

      static get properties() {
        return {
          searchString: String,
          strainData: {
            type: Array,
            value: []
          },
          loading: {
            type: Boolean,
            value: true,
          },
          noData: {
            type: Boolean,
            value: true,
          }
        };
      }

      searchStrain() {
        this.noData = false;
        this.loading = true;
        let self = this;
        if (this.searchString) {
          this.searchString = this.searchString.trim();
        }
        let resultData = {"strain_reviews":{"jesus og":{"Meta Chronic Average":{"url":"","strain":"jesus og","rating":4.627338129496402,"ratings":278},"Allbud":{"url":"https://www.allbud.com/marijuana-strains/sativa-dominant-hybrid/jesus-og","strain":"jesus og","rating":5.0,"ratings":19},"Leafly":{"url":"","strain":"jesus og","rating":4.6,"ratings":259}}, "black mountain x jesus og kush":{"Allbud":{"url":"https://www.allbud.com/marijuana-strains/sativa-dominant-hybrid/black-mountain-x-jesus-og-kush","strain":"black mountain x jesus og kush","rating":4.6,"ratings":25}},"baby jesus og":{"Allbud":{"url":"https://www.allbud.com/marijuana-strains/sativa-dominant-hybrid/baby-jesus-og","strain":"baby jesus og","rating":4.6,"ratings":20}}}};
        // fetch('https://ia19mmhldf.execute-api.us-east-1.amazonaws.com/Prod?strain=' + this.searchString).then(function(response) {
        //   response.text().then(function(text) {
        //     console.log(JSON.parse(text));
        //     self.updateTableData(resultData);
        //   });
        // }).then(function() {
        //   self.loading = false;
        // });
        self.updateTableData(resultData);
        self.loading = false;
      }

      updateTableData(resultData) {
        let newStrainData = [];
        resultData = resultData['strain_reviews']
        for (var currStrain in resultData) {
          let sourcesData = resultData[currStrain];

          let allbudData = {};
          if (sourcesData['Allbud']) {
            allbudData = {
              rating: sourcesData['Allbud']['rating'],
              ratings: sourcesData['Allbud']['ratings'],
              url: sourcesData['Allbud']['url']
            }
          }

          let leaflyData = {};
          if (sourcesData['Leafly']) {
            leaflyData = {
              rating: sourcesData['Leafly']['rating'],
              ratings: sourcesData['Leafly']['ratings'],
              url: sourcesData['Leafly']['url']
            }
          }

          let metaChronicData = {};
          if (sourcesData['Meta Chronic Average']) {
            metaChronicData = {
              rating: sourcesData['Meta Chronic Average']['rating'].toFixed(2),
              ratings: sourcesData['Meta Chronic Average']['ratings'],
            }
          }

          newStrainData.push({strain: currStrain, allbud: allbudData, leafly: leaflyData, metachronic: metaChronicData});
        }
        this.strainData = this.strainData.concat(newStrainData);
      }
    }

    window.customElements.define(MyReviews.is, MyReviews);
  </script>
</dom-module>